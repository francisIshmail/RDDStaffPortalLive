@model RDDStaffPortal.DAL.DataModels.LMS.RDD_LeaveType

@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_LMSLayout.cshtml";
}


@Html.HiddenFor(m => m.LeaveTypeId)
@Html.HiddenFor(m => m.Editflag, false)
<div class="container-fluid">
    <div class="row">


        <main role="main" class="col-md-9 mx-auto col-lg-10 pt-5 px-4">

            <div class="card mt-3 mb-3 box-shadow">
                <div class="card-header">
                    <div class="lftside-hding">
                        <h4 class="my-0 font-weight-bold">Leave Types </h4>
                    </div>
                    <div class="rgtside-btn">
                        <div class="nav-masthead">
                            <button type="button" class="btn btn-primary btn-lg" data-toggle="modal"
                                    data-target="#staticBackdrop">
                                Add Leave Type
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body inline-flex">


                    <div class="bs-example m-0">
                        <div class="accordion" id="accordionExample">
                            <div class="card" id="divcard">
                                <div class="card-header px-1 py-2 my-0" id="headingOne">
                                    <h2 class="mb-0">
                                        <button type="button" class="btn btn-link" data-toggle="collapse" data-target="#collapseOne">
                                            <i class="fa fa-plus"></i> Tanzania
                                        </button>
                                    </h2>

                                </div>

                                <div id="collapseOne" class="collapse" aria-labelledby="headingOne" data-parent="#accordionExample" style="text-align:center">
                                    <div class="card-body p-0">
                                        <div class="table-responsive">
                                            <table class="table" , id="usertable">
                                                <thead class="thead-light">
                                                    <tr>
                                                        @*<th scope="col">Country </th>*@
                                                        <th scope="col">Leave Types </th>
                                                        <th scope="col">Accrual Rule </th>
                                                        <th scope="col">Accrual Days </th>
                                                        @*<th scope="col">MinimumLeaveBalanceCondition </th>*@
                                                        <th scope="col">Laps At EOY</th>
                                                        <th scope="col">CarryFrwd Leave</th>
                                                        <th scope="col">Allow Negative Leave</th>
                                                        <th scope="col">Action</th>
                                                        @*<th scope="col"></th>*@
                                                    </tr>
                                                </thead>
                                                <tbody></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>



                        </div>
                    </div>




                    <!-- <button data-toggle="collapse" data-target="#india" class="btn btn-danger d-block mb-2">India</button>
                    <div id="india" class="collapse">
                      <div class="table-responsive">
                        <table class="table">
                          <thead class="thead-light">
                            <tr>
                              <th scope="col">Leave Types </th>
                              <th scope="col">Days </th>
                              <th scope="col">Description </th>
                              <th scope="col"></th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr>
                              <td>Annual Leave </td>
                              <td>2 days </td>
                              <td width="30%">
                                <p>Lorem Ipsum is simply dummy text of the printing and typesetting industry. </p>
                              </td>
                              <td width="25%">
                                <div class="rgtside-btn">
                                  <button type="button" class="btn btn-light defalt-btn">Mark as default </button>
                                  <div class="rounded-circle whtcircle"><i class="fas fa-pencil-alt"></i></div>
                                  <div class="rounded-circle redcircle"><i class="fas fa-trash-alt"></i></div>
                                </div>
                              </td>
                            </tr>
                            <tr>
                              <td>Annual Leave </td>
                              <td>2 days </td>
                              <td width="30%">
                                <p>Lorem Ipsum is simply dummy text of the printing and typesetting industry. </p>
                              </td>
                              <td width="25%">
                                <div class="rgtside-btn">
                                  <button type="button" class="btn btn-light defalt-btn">Mark as default </button>
                                  <div class="rounded-circle whtcircle"><i class="fas fa-pencil-alt"></i></div>
                                  <div class="rounded-circle redcircle"><i class="fas fa-trash-alt"></i></div>
                                </div>
                              </td>
                            </tr>


                          </tbody>
                        </table>
                      </div>
                    </div>
                    <button data-toggle="collapse" data-target="#Tanzania" class="btn btn-danger  d-block mb-2">Tanzania</button>
                    <div id="Tanzania" class="collapse">
                      <div class="table-responsive">
                        <table class="table">
                          <thead class="thead-light">
                            <tr>
                              <th scope="col">Leave Types </th>
                              <th scope="col">Days </th>
                              <th scope="col">Description </th>
                              <th scope="col"></th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr>
                              <td>Annual Leave </td>
                              <td>2 days </td>
                              <td width="30%">
                                <p>Lorem Ipsum is simply dummy text of the printing and typesetting industry. </p>
                              </td>
                              <td width="25%">
                                <div class="rgtside-btn">
                                  <button type="button" class="btn btn-light defalt-btn">Mark as default </button>
                                  <div class="rounded-circle whtcircle"><i class="fas fa-pencil-alt"></i></div>
                                  <div class="rounded-circle redcircle"><i class="fas fa-trash-alt"></i></div>
                                </div>
                              </td>
                            </tr>
                            <tr>
                              <td>Annual Leave </td>
                              <td>2 days </td>
                              <td width="30%">
                                <p>Lorem Ipsum is simply dummy text of the printing and typesetting industry. </p>
                              </td>
                              <td width="25%">
                                <div class="rgtside-btn">
                                  <button type="button" class="btn btn-light defalt-btn">Mark as default </button>
                                  <div class="rounded-circle whtcircle"><i class="fas fa-pencil-alt"></i></div>
                                  <div class="rounded-circle redcircle"><i class="fas fa-trash-alt"></i></div>
                                </div>
                              </td>
                            </tr>


                          </tbody>
                        </table>
                      </div>
                    </div> -->
                </div>
            </div>
        </main>
    </div>
</div>
<!-- Modal
=======================-->
<div class="modal fade" id="staticBackdrop" data-backdrop="static" data-keyboard="false" tabindex="-1"
     aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <button type="button" id="btnCloseModal" class="close" data-dismiss="modal">&times;</button>

            <div class="container-fluid">
                <div class="container-full">
                    <div class="col-12 bg-white">
                        <div class="modal-header">
                            <div class="headername">
                                <h3>New Leave Type </h3>
                            </div>
                        </div>
                        <div class="modal-body">
                            <form name="modal-form" method="post" action="">
                                <div class="form-group">
                                    <label for="country">Country: <i class="fas fa-star"></i></label>
                                        @*<select class="form-control" id="country"></select>*@
                                    @Html.DropDownListFor(m => m.Country, Model.CountryList, new { @class = "form-control" })

                                </div>
                                <div class="form-group">
                                    <label for="formGroupExampleInput">Leave Name: <i class="fas fa-star"></i></label>
                                    @Html.TextBoxFor(m => m.LeaveName, new { @class = "form-control form-control-sm txtcheck" })
                                    @Html.HiddenFor(m => m.LeaveTypeId)

                                    @*<input type="text" class="form-control" id="leavename" placeholder="">*@
                                </div>

                                <div class="form-group">
                                    <label for="country1">Accrual Rule: <i class="fas fa-star"></i></label>
                                    <select class="form-control" id="Accrule">
                                        <option>Monthly</option>
                                        <option>Quarterly</option>
                                        <option>HalfYearly</option>
                                        <option>Yearly</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="formGroupExampleInput">Accrual Days: <i class="fas fa-star"></i></label>
                                    @Html.TextBoxFor(m => m.AccruedDays, new { @class = "form-control form-control-sm txtcheck" })
                                    @Html.HiddenFor(m => m.LeaveTypeId)

                                    @*<input type="text" class="form-control" id="accrualdays" placeholder="">*@
                                </div>

                                <div class="form-group">
                                    <label for="formGroupExampleInput">Allow Maximum negative leave days: <i class="fas fa-star"></i></label>
                                    @Html.TextBoxFor(m => m.AllowMaximumNegativeLeaveDays, new { @class = "form-control form-control-sm txtcheck" })
                                    @Html.HiddenFor(m => m.LeaveTypeId)

                                    @*<input type="text" class="form-control" id="accrualdays" placeholder="">*@
                                </div>

                                <div class="form-group">
                                    <label for="formGroupExampleInput">Maximum carryforward leave to next year: <i class="fas fa-star"></i></label>
                                    @Html.TextBoxFor(m => m.MaximumLeavecarryForwardToNextYear, new { @class = "form-control form-control-sm txtcheck" })
                                    @Html.HiddenFor(m => m.LeaveTypeId)

                                    @*<input type="text" class="form-control" id="accrualdays" placeholder="">*@
                                </div>

                                <div class="form-group">
                                    Is Leave Laps At EOY
                                    <div class="input-group">
                                        <label class="switch">
                                            <input type="checkbox" id="chkIsDefaultMenu" value="true" checked><div></div>
                                        </label>
                                    </div>
                                    <!-- Rectangular switch -->
                                    @*<label class="switch">
                                            <input type="checkbox">
                                            <span class="slider"></span>
                                        </label>*@
                                </div>

                                @*<div class="form-group">
                                        <label for="formGroupExampleInput">Carry Forward to Next Year: <i class="fas fa-star"></i></label>
                                        <input type="text" class="form-control" id="leavename" placeholder="">
                                    </div>*@

                                @*<div class="form-group">

                                    Active
                                    <div class="input-group">
                                        <label class="switch">
                                            <input type="checkbox" id="chkIsDefaultMenu" value="true" checked><div></div>
                                        </label>
                                    </div>*@
                                    <!-- Rectangular switch -->
                                    @*<label class="switch">
                                            <input type="checkbox">
                                            <span class="slider"></span>
                                        </label>*@
                                </div>

                                <div class="modal-footer">
                                    <button type="button" class="btn btn-primary btn-lg blubtn" data-dismiss="modal" id="Save"> Save </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



@*<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>*@
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="~/Scripts/bootstrap.min.js"></script>
<link href="~/Content/bootstrap.min.css" rel="stylesheet" />
@*<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>*@
<script src="~/Scripts/RedDotUtility.js"></script>

<script type="text/javascript">

    var j = $.noConflict();


    j(document).ready(function () {
        GetLeaveDetails();
        

        j('#staticBackdrop').on('hidden.bs.modal', function (e) {
           
            j(this)
                .find("input,textarea")
                .val('')
                .end()

            j(this)
                .find("select")
                .trigger('change')
                .end()
        });
        //j(document).on("click", ".close", function () {
        //    j("#staticBackdrop").modal('toggle');
        //    j('.modal-backdrop').remove();
        //});
        //j('.staticBackdrop').on('hide.bs.modal', function () {
        //    if (j(this).is(':visible')) {
        //        console.log("show modal")
        //        j('.staticBackdrop').show();
        //    } else {
        //        console.log("hidden modal");
        //        j('.staticBackdrop').remove();
        //    }
        //});
        j(document).on("click", ".edit", function () {
            //j("#staticBackdrop").modal('show');
            var Currow = j(this).closest("tr");
            var LeaveNm = Currow.find('td:eq(0)').html();
            var AccrudRul = Currow.find('td:eq(1)').html();
            var AccrudDys = Currow.find('td:eq(2)').html();
            var AllwMaxNegtiveLveDys = Currow.find('td:eq(5)').html();
            var Maxlvcrryfrwdtonxtyr = Currow.find('td:eq(4)').html();
            var Countrycde = Currow.find('td:eq(7)').html();
            var LeaveTypeId = Currow.find('td:eq(8)').html();
            var IsDefault = Currow.find('td:eq(3)').html();
            if (IsDefault == 'No') {
                j("#chkIsDefaultMenu").val('false');
                j("#chkIsDefaultMenu").removeAttr('checked');
            } else {
                j("#chkIsDefaultMenu").attr('checked', 'checked');
                j("#chkIsDefaultMenu").val('true')
            }

            
            j("#LeaveTypeId").val(LeaveTypeId);
            j("#Country").val(Countrycde.trim()).trigger('change');
            j("#LeaveName").val(LeaveNm);
            j("#Accrule").val(AccrudRul);
            j("#AccruedDays").val(AccrudDys);
            j("#AllowMaximumNegativeLeaveDays").val(AllwMaxNegtiveLveDys);
            j("#MaximumLeavecarryForwardToNextYear").val(Maxlvcrryfrwdtonxtyr);
            //var LeaveIde = $(this).attr("data");
            //j("#LeaveTypeId").val(LeaveIde);
            j("#Save").text("Update");
            j("#Save").attr("id", "btnUpdate");
            j(".add-new").attr("disabled", "disabled");
            
        });

        //Checkbox for IsLeaveLapse at EOY
        $("input[type='checkbox']").on("click", function () {
            if ($("#chkIsDefaultMenu").val() == 'true') {
                $("#chkIsDefaultMenu").val('false');
                $("#chkIsDefaultMenu").removeAttr('checked');
            } else {
                $("#chkIsDefaultMenu").attr('checked', 'checked');
                $("#chkIsDefaultMenu").val('true')
            }

        }
        )

        // Delete row on delete button click
        j(document).on("click", ".dlt", function () {
            debugger
            //j(this).parents("tr").remove();
            var tr = j(this).parents("tr");
            j(".add-new").removeAttr("disabled");
            var LeaveTypeId = j(this).attr("data");
            // var LeaveTypeId = Currow.find('td:eq(8)').html();
            DeleteFlag = true;
            const swalWithBootstrapButtons = Swal.mixin({
                confirmButtonClass: 'btn btn-success',
                cancelButtonClass: 'btn btn-danger',
                buttonsStyling: false,
            })
            swalWithBootstrapButtons.fire({
                title: 'Are you sure?',
                text: "You won't be able to revert this!",
                type: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, delete it!',
                cancelButtonText: 'No, cancel!',
                reverseButtons: true
            }).then((result) => {
                if (result.value) {
                    j.ajax({
                        type: "POST",
                        url: "/DeleteLeaveType",
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        data: JSON.stringify({ LeaveTypeId: LeaveTypeId }),
                        success: function (data) {
                            debugger
                            if (data.data[0].Outtf == true) {
                                tr.remove();
                                //RedDotAlert_Success(response.data.ErrorMsg);
                                RedDotAlert_Success(data.data[0].Responsemsg);
                                //RedDotAlert_Success("Data deleted successfully");
                                //window.location.href = '@Url.Action("Index", "RDD_LeaveType")';

                            }
                            else {
                                RedDotAlert_Error(data.data[0].Responsemsg)

                            }
                        }
                    });
                }
                else if (result.dismiss === Swal.DismissReason.cancel) {
                    swalWithBootstrapButtons.fire(
                        'Cancelled',
                        'Your Record  is safe :)',
                        'error'
                    )
                }


            });
        });
        j(document).on("click", "#btnUpdate", function () {
            var rDD_LeaveType = {
                LeaveTypeId: $("#LeaveTypeId").val(),
                Country: j("#Country").val(),
                LeaveName: j("#LeaveName").val(),
                AccruedDays: j('#AccruedDays').val(),
                AccruedRule: j("#Accrule option:selected").text(),
                AllowMaximumNegativeLeaveDays: j('#AllowMaximumNegativeLeaveDays').val(),
                MaximumLeavecarryForwardToNextYear: j('#MaximumLeavecarryForwardToNextYear').val(),
                IsLeaveLapseAtEndOfYear: $("#chkIsDefaultMenu").val(),
                Editflag: true
            };
            j.ajax({
                type: "POST",
                url: "/SaveLeaveType",
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                data: JSON.stringify({ rDD_LeaveType: rDD_LeaveType }),
                success: function (data) {

                    if (data.Saveflag == true) {
                        RedDotAlert_Success("Data updated successfully");
                        window.location.href = '@Url.Action("Index", "RDD_LeaveType")';
                        GetLeaveDetails();
                    }
                    else {
                        RedDotAlert_Error(data.ErrorMsg)
                        //alert("Data not saved");
                    }
                }
            });
        });
        $(document).on('click', '#btnCloseModal', function () {
            //j("#Save").attr("id", "btnUpdate");
            $("#btnUpdate").text("Save");
            $("#btnUpdate").attr("id", "Save");
        });

        j(document).on("click", "#Save", function () {
            var Errmsg = "";            if (j("#Country").val() == "0") {                Errmsg = Errmsg + "Select Country "            }            else if (j("#LeaveName").val() == "") {                Errmsg = Errmsg + "Enter the leave name "            }            else if (j("#AccruedDays").val() == "0") {                Errmsg = Errmsg + "Enter Accrual Days "            }            else if (j("#Accrule option:selected").text() == "") {                Errmsg = Errmsg + "Enter Accrual Rule "            }            //else if (j("#AllowMaximumNegativeLeaveDays").val() == "0") {            //    Errmsg = Errmsg +"Enter AllowMaximumLeaveDays Field "            //}            //else if (j("#MaximumLeavecarryForwardToNextYear").val() == "0") {            //    Errmsg = Errmsg +"Enter MaximumLeavecarryForwardToNextYear's Field "            //}            if (Errmsg.length > 0) {                RedDotAlert_Error("Please " + Errmsg);                return;            }
            
            var rDD_LeaveType = {
                Country: j("#Country").val(),
                LeaveName: j("#LeaveName").val(),
                AccruedDays: j('#AccruedDays').val(),
                AccruedRule: j("#Accrule option:selected").text(),
                AllowMaximumNegativeLeaveDays: j('#AllowMaximumNegativeLeaveDays').val(),
                MaximumLeavecarryForwardToNextYear: j('#MaximumLeavecarryForwardToNextYear').val(),
                //MenuData["IsDefault"] = $("#chkIsDefaultMenu").is(":checked")
                IsLeaveLapseAtEndOfYear: $("#chkIsDefaultMenu").val()

            };
            debugger
            j.ajax({
                type: "POST",
                url: "/SaveLeaveType",
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                data: JSON.stringify({ rDD_LeaveType: rDD_LeaveType }),
                success: function (data) {

                    if (data.Saveflag == true && data.LeaveTypeId != -1) {
                        RedDotAlert_Success("Data saved successfully");
                        window.location.href = '@Url.Action("Index", "RDD_LeaveType")';

                    }
                    else {
                        RedDotAlert_Error(data.ErrorMsg)
                        //alert("Data not saved");
                    }
                }
            });
        });
    });
    function GetLeaveDetails() {
        j("#accordionExample").hide();
        j.ajax({
            type: "POST",
            url: '@Url.Action("GetLeaveDetails","RDD_LeaveType")',
            dataType: "json",
            success: function (data) {
                debugger
                var lookup = {};
                var items =data;
                var result = [];
                var result1 = [];

                for (var item, i = 0; item = items[i++];) {
                    var name = item.Country;
                    if (!(name in lookup)) {
                        lookup[name] = 1;
                        result.push(name);
                        result1.push(item.CountryCode);
                    }
                }
                debugger

                if (result.length > 0) {
                    var i = 0;

                    while (result.length > i) {
                        debugger

                        var t = $("#divcard").clone();
                        t.find("#headingOne [type='button']").attr("data-target", "#collapseOne" + i);
                        t.find("#collapseOne").attr("id", "collapseOne" + i);
                        t.find("#headingOne [type='button']").html("<i class='fa fa-plus'></i>" + result[i] + "");
                        t.find(".table").attr("id", "tbl"+result1[i]);
                        $("#accordionExample").append(t);

                        i++;
                    }
                    if (i == result.length) {
                        $('#divcard')[0].remove();
                        j("#accordionExample").show();
                    }

                }
                var i1 = 0;
                while (data.length > i1) {
                    debugger
                    var t = "#tbl" + data[i1].CountryCode;
                    var isleave = data[i1].IsLeaveLapseAtEndOfYear == true ? 'Yes' : 'No';
                    $(t + " tbody").append('<tr><td>' + data[i1].LeaveName + '</td><td>' + data[i1].AccruedRule + '</td><td>' + data[i1].AccruedDays + '</td><td>' + isleave + '</td><td>' + data[i1].MaximumLeavecarryForwardToNextYear + '</td><td>' + data[i1].AllowMaximumNegativeLeaveDays + '</td><td>' + '<button class="btn edit" data-toggle="modal" data-target="#staticBackdrop"   data="' + data[i1].LeaveTypeId + '"><i class="fas fa-pencil-alt"></i>' + '<button class="btn dlt" data="' + data[i1].LeaveTypeId + '"><i class="fas fa-trash-alt"></i>' + '</td><td style="display:none;">' + data[i1].CountryCode + '</td><td style="display:none;">' + data[i1].LeaveTypeId + '</td></tr>' )
                    i1++;
                }

            }
        });





    }
    

</script>
